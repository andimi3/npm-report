<!DOCTYPE html>
<html>
    <head>

        <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"> -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

        <style>

            body{margin-top:20px;}

            .chat-online {
                color: #34ce57
            }
            
            .chat-offline {
                color: #e4606d
            }
            
            .chat-messages {
                display: flex;
                flex-direction: column;
                max-height: 500px;
                overflow-y: scroll
            }
            
            .chat-message-left,
            .chat-message-right {
                display: flex;
                flex-shrink: 0
            }
            
            .chat-message-left {
                margin-right: auto
            }
            
            .chat-message-right {
                flex-direction: row-reverse;
                margin-left: auto
            }
            .py-3 {
                padding-top: 1rem!important;
                padding-bottom: 1rem!important;
            }
            .px-4 {
                padding-right: 1.5rem!important;
                padding-left: 1.5rem!important;
            }
            .flex-grow-0 {
                flex-grow: 0!important;
            }
            .border-top {
                border-top: 1px solid #dee2e6!important;
            }       

        </style>     

    </head>

    <body>

        <main class="content">
            <div class="container p-0">
                
                <div class="card">
                    <div class="row g-0">
                        <div class="col-12 col-lg-5 col-xl-3 border-right">
        
                            <div class="px-4 d-none d-md-block">
                                <div class="d-flex align-items-center">
                                    <div class="flex-grow-1">
                                        <input id = "searchBar" type="text" class="form-control my-3" placeholder="Search...">
                                    </div>
                                </div>
                            </div>

                            <!-- client side people -->

                            <div id = "clientSidePeople">
        
                            <!-- <div class="list-group-item list-group-item-action border-0">
                                <div class="badge bg-success float-right">5</div>
                                <div class="d-flex align-items-start">
                                    <img src="https://bootdey.com/img/Content/avatar/avatar5.png" class="rounded-circle mr-1" alt="Vanessa Tucker" width="40" height="40">
                                    <div class="flex-grow-1 ml-3">
                                        Vanessa Tucker
                                        <div class="small"><span class="fas fa-circle chat-online"></span> Online</div>
                                    </div>
                                </div>
                            </div> -->

                            </div>

                            <!-- client side people -->
        
                        <hr class="d-block d-lg-none mt-1 mb-0">
                        </div>
                        <div class="col-12 col-lg-7 col-xl-9">
                            <div class="py-2 px-4 border-bottom d-none d-lg-block">
                                <div class="d-flex align-items-center py-1">
                                    <div class="position-relative">
                                        <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                                    </div>
                                    <div class="flex-grow-1 pl-3">
                                        <strong id = "mainName">Sharon Lessman</strong>
                                        <div class="text-muted small"><em id = "mainTyping">Typing...</em></div>
                                    </div>
                                    <div>
                                        <button id = "export" class="btn btn-primary btn-sm mr-1 px-3 topLevelButtons">Export</button>
                                        <button id = "block" class="btn btn-info btn-sm mr-1 px-3 d-none d-md-inline-block topLevelButtons">Block</button>
                                        <button id = "merge" class="btn btn-light border btn-sm px-3 topLevelButtons">Merge offline conversations</button>
                                        <button id = "videoCall" class="btn btn-light border btn-sm px-3 topLevelButtons">Video Call</button>
                                        <button id = "delete" class="btn btn-danger border btn-sm px-3 topLevelButtons">Delete All</button>
                                    </div>
                                </div>
                                <br>
                                <small id = "tlError" style = "color: red"></small>
                            </div>
        
                            <div class="position-relative">

                                <!-- messages -->

                                <div class="chat-messages p-4" id = "messagesByName">

                                    <!-- <div class="chat-message-left pb-4">
                                        <div>
                                            <img src="https://bootdey.com/img/Content/avatar/avatar3.png" class="rounded-circle mr-1" alt="Sharon Lessman" width="40" height="40">
                                            <div class="text-muted small text-nowrap mt-2">2:34 am</div>
                                        </div>
                                        <div class="flex-shrink-1 bg-light rounded py-2 px-3 ml-3">
                                            <div class="font-weight-bold mb-1">Sharon Lessman</div>
                                            Sit meis deleniti eu, pri vidit meliore docendi ut, an eum erat animal commodo.
                                        </div>
                                    </div> -->

                                </div>

                                <!-- messages -->

                            </div>
        
                            <div class="flex-grow-0 py-3 px-4 border-top">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Type your message" id = "myMessage">
                                </div>
                                <br>
                                <button class="btn btn-primary" id = "sendMessage">Send</button>
                            </div>
        
                        </div>
                    </div>
                </div>
            </div>
        </main> 
        
    <!-- Modal fir top level buttons -->

    <div class="modal fade" id="mergeModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel" id = "mergeTitle">Merge offline conversations into one converstation</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div class="modal-body" id = "mergeBody">
            
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-primary" id = "mergeSubmit">Merge</button>
            <p style = "color: red; text-align: center">Merging will delete all conversations exept the mergers</p>
            </div>
        </div>
        </div>
    </div>   
    
    <!-- Modal fir top level buttons -->

        
        <script>

            socket = (() => {

                console.log("page has been refreshed");
                
                let employeePassword = "employee";
                let clientArray = [];
                let messageArray = [];
                let employeeResourceId = null;
                let currentClientId = null;
                let mergeSafe = [];
                let blocked = [];
                let conn = new WebSocket(`ws://localhost:8082?employee=${employeePassword}`);

                let searchbar = document.getElementById("searchBar");
 
                searchbar.onkeyup = function() { 
                    search(this.value.trim().toLowerCase());
                } 

                let clientNames = document.getElementsByClassName("clientNames");
                let hideElements = document.getElementsByClassName("hideElements");

                let tlb = document.getElementsByClassName("topLevelButtons");

                for(let i = 0; i < tlb.length; i++) { 
                    tlb[i].onclick = function () {
                         tLF(this.id); 
                    } 
                }

                let tempExportedMessages = [];
                let tempMergeIds = [];      
                let mergeOrExportState = null;   

                document.getElementById("mergeSubmit").onclick = () => { 
                    merge(); 
                };

                document.getElementById("sendMessage").onclick = () => { 
                    sendMessage(document.getElementById("myMessage"));
                }

                conn.onmessage = (e) => {

                    //if client connects
                    if(e.data.split("-")[0] === "addToArray") { 
                        clientArray.push(parseInt(e.data.split("-")[1]));
                        elem("add", e.data.split("-")[1], e.data.split("-")[2]);
                        clientArray.length === 1 ? switchClient(e.data.split("-")[1]) : console.log("there are clients to select from");
                        return;
                    }

                    //if client loses connection
                    if(e.data.split("-")[0] === "removeFromArray") { 
                        clientArray.splice(clientArray.indexOf(parseInt(e.data.split("-")[1])), 1); //need to fix this on refresh... clients instance is still live triggering this. could just send a message, split on it and close there connection from the client as well as the server...
                        elem("remove", e.data.split("-")[1], null);
                        return;
                    }

                    //if employee gets connected <- for messages
                    if(e.data.split("-")[0] === "employeeConnected") { 
                        employeeResourceId = parseInt(e.data.split("-")[1]);
                        return;
                    }      

                    //you have blocked this person from sending messages
                    if(blocked.includes(parseInt(e.data.split("-")[1]))) {
                        return;
                    }

                    //if the client is typing
                    if(e.data.split("-")[0] === "37uiudnjd" && currentClientId === parseInt(e.data.split("-")[1])) { 
                        if(parseInt(document.getElementById("mainTyping").innerText.trim().length) === 3) { document.getElementById("mainTyping").innerText = ""; return;  }
                        document.getElementById("mainTyping").innerText += ".";
                        return;
                    }

                    //BUG: when a client disconnects after i have disconnected everyone(from refreshing) they are sending me over an id that i am removing from an array. 
                    //to stop this on refresh just add a pram on send message when conn close to kill their instance on their side until i find out why
                    //REMOVE BELOW IF STATEMENT IF YOU WANT WORKING ON REFRESH RESULTS...

                    //if there data isnt found in any array that means i have removed the client
                    if((!clientArray.includes(parseInt(e.data.split("-")[1]))) && (!blocked.includes(parseInt(e.data.split("-")[1]))) && (!mergeSafe.includes(parseInt(e.data.split("-")[1])))) {
                        return;
                    }

                    var today = new Date();
                    var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();

                    //if a message push the values to an array of objects
                    messageArray.push({
                        clientId: e.data.split("-")[1], 
                        message: e.data.split("-")[0], 
                        employeeId: e.data.split("-")[2],
                        time: time
                    });

                    //if you are on the persons screen who sent a message move down
                    if(currentClientId === parseInt(e.data.split("-")[1]) || (e.data.split("-")[2] !== "fromThem" && currentClientId === parseInt(e.data.split("-")[1]))) {

                        //from me
                        if(e.data.split("-")[2] !== "fromThem") {
                            document.getElementById("messagesByName").innerHTML += `
                            <div class="chat-message-right pb-4">
                                <div>
                                    <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">
                                    <div class="text-muted small text-nowrap mt-2">${time}</div>
                                    </div>
                                <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                                    <div class="font-weight-bold mb-1">You</div>
                                    ${e.data.split("-")[0]}
                                </div>
                            </div>`;
                        }

                        //from them
                        if(e.data.split("-")[2] === "fromThem") {
                            document.getElementById("messagesByName").innerHTML += `
                            <div class="chat-message-left pb-4">
                                <div>
                                    <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">
                                    <div class="text-muted small text-nowrap mt-2">${time}</div>
                                    </div>
                                <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                                    <div class="font-weight-bold mb-1">Client</div>
                                    ${e.data.split("-")[0]}
                                </div>
                            </div>`;
                        }

                        var element = document.getElementById("messagesByName");
                        element.scrollTop = element.scrollHeight;
                        return;

                    }

                    //increase number for on message if not on client screen
                    if(e.data.split("-")[2] === "fromThem") { 
                        document.getElementById(`${e.data.split("-")[1]}-chatCount`).innerText = parseInt(document.getElementById(`${e.data.split("-")[1]}-chatCount`).innerText.trim()) + 1;
                     }

                };

                elem = (decision, id, name) => {

                    //add client to side bar
                    if(decision === "add") {
                        document.getElementById("clientSidePeople").innerHTML += `
                        <div id = "${id}-identitySet" onclick = "switchClient(${id})" class="list-group-item list-group-item-action border-0 hideElements">
                                <div id = "${id}-chatCount" class="badge bg-success float-right">0</div>
                                <div class="d-flex align-items-start">
                                    <img src="https://bootdey.com/img/Content/avatar/avatar5.png" class="rounded-circle mr-1" alt="Vanessa Tucker" width="40" height="40">
                                    <div class="flex-grow-1 ml-3">
                                        <span class = "clientNames" id = "${id}-clientName" >${name.trim()}</span>
                                    <div class="small"><span class="fas fa-circle chat-online"></span><b id = "${id}-online">Online</b><b id = "${id}-blocked"></b></div>
                                    </div>
                                </div>
                            </div>                        
                        `;
                    }

                    //update client to offline and push to merge option
                    if(decision === "remove") {
                        try {
                            document.getElementById(`${id}-online`).innerText = "offline";
                            let elemName = document.getElementById(`${id}-clientName`).innerText.trim();
                            mergeSafe.push({name: elemName, id: parseInt(id)});
                        } catch {
                            console.log("initial connection");
                        }
                    }

                }

                switchClient = (id) => {

                    currentClientId = parseInt(id);

                    document.getElementById(`${id}-chatCount`).innerText = 0;

                    document.getElementById("messagesByName").innerHTML = "";

                    document.getElementById("mainName").innerText = document.getElementById(`${id}-clientName`).innerText;

                    document.getElementById("mainTyping").innerText = "";

                    document.getElementById("tlError").innerText = "";

                    for(let i = 0; i < messageArray.length; i++) {

                        //message coming from me - right side -- can just do if (employee id) === instead of this
                        if(messageArray[i].employeeId !== "fromThem" && parseInt(messageArray[i].clientId) === currentClientId) {
                            document.getElementById("messagesByName").innerHTML += `
                            <div class="chat-message-right pb-4">
                                <div>
                                    <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">
                                    <div class="text-muted small text-nowrap mt-2">${messageArray[i].time}</div>
                                    </div>
                                <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                                    <div class="font-weight-bold mb-1">You</div>
                                    ${messageArray[i].message}
                                </div>
                            </div>`;
                        }
                        
                        //message coming from them - left side
                        if(messageArray[i].employeeId === "fromThem" && parseInt(messageArray[i].clientId) === currentClientId) {
                            document.getElementById("messagesByName").innerHTML += `
                            <div class="chat-message-left pb-4">
                                <div>
                                    <img src="https://bootdey.com/img/Content/avatar/avatar1.png" class="rounded-circle mr-1" alt="Chris Wood" width="40" height="40">
                                    <div class="text-muted small text-nowrap mt-2">${messageArray[i].time}</div>
                                    </div>
                                <div class="flex-shrink-1 bg-light rounded py-2 px-3 mr-3">
                                    <div class="font-weight-bold mb-1">Client</div>
                                    ${messageArray[i].message}
                                </div>
                            </div> `;
                        }

                    }

                    var element = document.getElementById("messagesByName");
                    element.scrollTop = element.scrollHeight;

                }

                function search(v) { 

                        if(v === "") { 
                            for(let i = 0; i < clientNames.length; i++) { 
                                hideElements[i].style.display = "block"; 
                            }
                            return; 
                        } 

                        for(let i = 0; i < clientNames.length; i++) {
                            if(clientNames[i].innerText.trim().toLowerCase().includes(v)) { 
                                hideElements[i].style.display = "block"; 
                            } else { 
                                hideElements[i].style.display = "none";
                            }
                        }

                }

                function tLF(value) {

                    switch(value) {

                        case "export":

                            tempExportedMessages = [];

                            let name = document.getElementById(`${currentClientId}-clientName`).innerText.trim();

                            for(let i = 0; i < messageArray.length; i++) {

                                if(parseInt(messageArray[i].clientId) === currentClientId && messageArray[i].employeeId === "fromThem") {
                                    tempExportedMessages.push({
                                        name: name,
                                        message: messageArray[i].message,
                                        time: messageArray[i].time
                                    });
                                }

                                if(messageArray[i].employeeId !== "fromThem" && parseInt(messageArray[i].clientId) === currentClientId) {
                                    tempExportedMessages.push({
                                        name: "employee", // <--- add your name here on employee input
                                        message: messageArray[i].message,
                                        time: messageArray[i].time
                                    });
                                }

                            }

                            if(tempExportedMessages.length === 0) { 
                                document.getElementById("tlError").innerText = "There is no conversation to export in this thread!"; 
                                document.getElementById("tlError").style.color = "red"; 
                                return; 
                            }

                            exportToDatabase();

                        break;

                        case "delete":

                            deleteThisPerson(currentClientId);

                        break;

                        case "merge":

                            if(mergeSafe.length === 0) { 
                                document.getElementById("tlError").innerText = "There are no offline conversations to merge"; 
                                document.getElementById("tlError").style.color = "red"; 
                                return; 
                            }

                            tempMergeIds = [];

                            document.getElementById("mergeBody").innerHTML = "";

                            for(let i = 0; i < mergeSafe.length; i++) {

                                if(mergeSafe[i].id === currentClientId) { 
                                    continue; 
                                }

                                document.getElementById("mergeBody").innerHTML += `
                                <div class="form-check">
                                    <input class="form-check-input pushMergedIds" type="checkbox" value="" id="flexCheckDefault" value "${mergeSafe[i].id}">
                                    <label class="form-check-label" for="flexCheckDefault" style = "margin-bottom: 3px">
                                    Name: ${mergeSafe[i].name} Id: ${mergeSafe[i].id}
                                    </label>
                                </div>`;

                            }

                            $('#mergeModal').modal('show');

                        break;

                        case "block":

                            if(blocked.includes(currentClientId)) {
                                blocked.splice(blocked.indexOf(currentClientId), 1);
                                document.getElementById(`${currentClientId}-blocked`).innerText = "";
                                return;  
                            };

                            blocked.push(currentClientId); 
                            document.getElementById(`${currentClientId}-blocked`).innerText = "-blocked";

                        break;

                        case "videoCall":

                        //kill any exixsting rtc connections (theres and mine) or just keep mine the same and cange params on mine for their side { me me me, [them them them] <- update }
                        //generate my rtc connection [if i choose not to update]
                        //send a message that generates their rtc and attach my id'd rtc connection. -> display on their screen (generate and config for both sides)
                        //send back their id'd rtc connection to attach to mine
                        //display their connection on my screen and my connection on their screen
                        //when leave kill mine and their connection. [or just kill theirs so i can update mine] ..not sure
                        document.getElementById("messagesByName").innerHTML = "VIDEO";

                        break;

                    }

                }

                merge = () => {

                    let checkBoxes = document.getElementsByClassName("pushMergedIds");

                    for(let i = 0; i < checkBoxes.length; i++) {
                        if(checkBoxes[i].checked === true) { 
                            tempMergeIds.push(parseInt(checkBoxes[i].value)) 
                        };
                    }

                    for(let i = 0; i < messageArray.length; i++) { 
                        if(tempMergeIds.includes(parseInt(messageArray[i].clientId))) { 
                            messageArray[i].clientId = currentClientId; 
                        } 
                    }

                    for(let i = 0; i < tempMergeIds.length; i++) {
                        deleteThisPerson(tempMergeIds[i]);
                    }

                    document.getElementById("tlError").innerText = "You have successfully merged!";
                    document.getElementById("tlError").style.color = "green";

                }


                exportToDatabase = () => {

                    //push "tempExportedMessages" to database however you wish

                    document.getElementById("tlError").innerText = "You have successfully exported to database!";
                    document.getElementById("tlError").style.color = "green";

                }

                deleteThisPerson = (clientId) => {
                  //remove element and arrays with data and also remove their connection on server and their client instance ...until i know why killing on server doesnt kill theirs
                }

                rtcInit = () => {
                    //do everything you said in above here... 
                }

                conn.onerror = (e) => {
                    alert("ERROR CONNECTING" + e);
                }

                sendMessage = (v) => {
                    if(blocked.includes(currentClientId)) { return; }
                    conn.send(`${v.value}-${currentClientId}-${employeePassword}`);
                    v.value = "";
                }

            })();


            //we're gonna throw em some php and see how they react. lets see all the remarks they make
            //hate it before you scrolled down i already forgave ya - j cole
            //https://www.youtube.com/watch?v=WFoZJrZrL8w
            

        </script>

        <!-- for modal -->
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>


        
    </body>
</html>
